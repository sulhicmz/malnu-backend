version: '3.8'

services:
  # Service for the Hyperf application
  app:
    # Use the official Hyperf image with a specific PHP and Swoole version
    # Choose the image tag that matches your PHP version (e.g., 8.3) and desired Swoole version
    # The alpine variant is generally smaller and recommended for production
    image: hyperf/hyperf:8.3-alpine-v3.19-swoole-v6
    # Use the hyperf/hyperf:8.3-alpine-v3.19-swoole-v6 image as suggested in the documentation.
    # Ensure this matches your PHP version and Swoole requirements.

    # Map the current directory (your Hyperf project root) to the project directory in the container
    # This allows you to edit code on your host machine and have it reflected in the container
    volumes:
      - .:/data/project
      # If you are on a system with SELinux enabled and encounter permission issues,
      # you might need to add `:Z` or `:z` to the volume mount, e.g., `.:/data/project:Z`
      # Or add the `--privileged -u root` flags as mentioned in the documentation,
      # though using volumes with proper permissions is generally preferred.

    # Expose the port Hyperf listens on (default is 9501)
    ports:
      - "9501:9501"
      # Map host port 9501 to container port 9501

    # Set the working directory inside the container
    working_dir: /data/project

    # Command to run when the container starts
    # This starts the Hyperf development server with hot-reloading enabled
    # For production, you might use `php artisan start` or a different command
    command: sh -c "composer install && php artisan watch"
    # `composer install` ensures dependencies are installed inside the container
    # `php artisan watch` starts the server with hot-reload for development

    # Environment variables (optional, can be read from .env file automatically by Hyperf)
    # You can explicitly set variables here if needed, but relying on the .env file is standard.
    # env_file:
    #   - .env

    # Link to the database and Redis services
    depends_on:
      - db # Link to the database service defined below
      - redis # Link to the Redis service defined below

  # MySQL Database Service for production and development
  db:
    image: mysql:8.0
    container_name: malnu_mysql
    ports:
      - "3306:3306" # Map host port 3306 to container port 3306
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-malnu_root_password_2024}
      MYSQL_DATABASE: ${DB_DATABASE:-malnu_backend}
      MYSQL_USER: ${DB_USERNAME:-malnu_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-malnu_password_2024}
    volumes:
      - dbdata:/var/lib/mysql # Persist database data
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro # Custom MySQL configuration
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-malnu_root_password_2024}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - malnu_network

  # PostgreSQL Database Service (Alternative to MySQL - Uncomment to use instead of MySQL)
  # Note: Only enable one database service at a time (MySQL or PostgreSQL)
  # postgres:
  #   image: postgres:16 # Use the latest stable PostgreSQL version
  #   container_name: malnu_postgres
  #   ports:
  #     - "5432:5432" # Map host port 5432 to container port 5432
  #   environment:
  #     POSTGRES_DB: ${DB_DATABASE:-malnu_backend}
  #     POSTGRES_USER: ${DB_USERNAME:-malnu_user}
  #     POSTGRES_PASSWORD: ${DB_PASSWORD:-malnu_password_2024}
  #   volumes:
  #     - pgdata:/var/lib/postgresql/data # Persist PostgreSQL data
  #     - ./docker/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro # Custom PostgreSQL configuration
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-malnu_user} -d ${DB_DATABASE:-malnu_backend}"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s
  #   restart: unless-stopped
  #   networks:
  #     - malnu_network

  # Redis Service for caching, sessions, and queues
  redis:
    image: redis:7-alpine # Use Redis 7 Alpine image for better performance
    container_name: malnu_redis
    ports:
      - "6379:6379" # Map host port 6379 to container port 6379
    volumes:
      - redisdata:/data # Persist Redis data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - malnu_network

# Define volumes for data persistence
volumes:
  dbdata: # Volume for MySQL data
  pgdata: # Volume for PostgreSQL data
  redisdata: # Volume for Redis data persistence

# Define network for inter-container communication
networks:
  malnu_network:
    driver: bridge
