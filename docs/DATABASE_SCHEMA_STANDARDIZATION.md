# Database Schema Standardization Guide

This document provides guidance on proper UUID implementation and schema management in the Malnu Backend School Management System.

## UUID Implementation Standards

### Current State

Historically, migrations in this codebase used the following pattern for UUID primary keys:

```php
$table->uuid('id')->primary()->default(Db::raw('(UUID())'));
```

This approach has several issues:
- Database-dependent raw SQL (MySQL-specific UUID() function)
- Not portable across different database systems
- Unnecessary defaults when using proper model configuration

### Proper UUID Implementation

For new migrations, use the following approach:

```php
use Hyperf\Database\Migrations\Migration;
use Hyperf\Database\Schema\Blueprint;
use Hyperf\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('table_name', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->string('name');
            $table->timestamps();
        });
    }
};
```

### Model Configuration

Models using UUID primary keys should be configured as follows:

```php
namespace App\Models;

use App\Models\Model;
use App\Traits\UsesUuid; // Optional, for creating new records

class MyModel extends Model
{
    use UsesUuid; // Use if creating records via Model::create()

    protected $primaryKey = 'id';
    protected $keyType = 'string';
    public $incrementing = false;

    protected $fillable = [
        'name',
    ];
}
```

**Key Properties:**
- `$primaryKey = 'id'` - Explicitly set primary key column
- `$keyType = 'string'` - Tell Eloquent the key type is string (UUID)
- `$incrementing = false` - Disable auto-incrementing
- `UsesUuid` trait - Optional, for creating new records with auto-generated UUIDs

### When to Use UsesUuid Trait

The `UsesUuid` trait is useful when:
- Creating new records programmatically using `Model::create()`
- Need auto-generated UUIDs for model instances

The trait is NOT required when:
- Records are created via API/Controller (UUIDs generated by database default)
- Working with existing records (UUIDs already set)

## Foreign Key Constraints

### Best Practices

Always define foreign key constraints for relationships:

```php
Schema::create('students', function (Blueprint $table) {
    $table->uuid('id')->primary();
    $table->uuid('user_id')->nullable();
    $table->uuid('class_id')->nullable();
    $table->uuid('parent_id')->nullable();
    
    $table->timestamps();
    
    $table->foreign('user_id')
        ->references('id')
        ->on('users')
        ->onDelete('cascade');
        
    $table->foreign('class_id')
        ->references('id')
        ->on('classes')
        ->onDelete('set null');
        
    $table->foreign('parent_id')
        ->references('id')
        ->on('parents')
        ->onDelete('set null');
});
```

### Cascade Actions

Choose appropriate cascade actions:
- `'cascade'` - Delete related records when parent is deleted (for child records)
- `'set null'` - Set foreign key to NULL when parent is deleted (for optional relationships)
- `'restrict'` - Prevent deletion if related records exist (for critical relationships)

### Common Patterns

**User-Owned Records:**
```php
$table->foreign('user_id')
    ->references('id')
    ->on('users')
    ->onDelete('cascade');
```

**Optional Relationships:**
```php
$table->foreign('teacher_id')
    ->references('id')
    ->on('teachers')
    ->onDelete('set null');
```

## Indexes for UUID Columns

### Why Indexes Matter

UUID columns used in JOIN operations benefit significantly from indexes:
- Faster query performance on JOIN operations
- Reduced database load
- Better application response times

### Adding Indexes to UUID Columns

```php
Schema::table('students', function (Blueprint $table) {
    $table->index('class_id', 'idx_students_class_id');
    $table->index('parent_id', 'idx_students_parent_id');
    $table->index('status', 'idx_students_status');
});
```

### Composite Indexes for Common Query Patterns

For frequently queried combinations:

```php
Schema::table('students', function (Blueprint $table) {
    $table->index(['class_id', 'status'], 'idx_students_class_status');
});
```

## Migration Naming Conventions

Use descriptive migration names:

```bash
2026_01_09_000000_create_feature_name_table.php
2026_01_09_000001_add_indexes_to_table_name.php
2026_01_09_000002_standardize_uuid_implementation.php
```

## Model Relationships

### Defining Relationships

```php
class Student extends Model
{
    public function user()
    {
        return $this->belongsTo(User::class, 'user_id');
    }
    
    public function class()
    {
        return $this->belongsTo(ClassModel::class, 'class_id');
    }
    
    public function parent()
    {
        return $this->belongsTo(ParentOrtu::class, 'parent_id');
    }
}
```

### Inverse Relationships

```php
class ClassModel extends Model
{
    public function students()
    {
        return $this->hasMany(Student::class, 'class_id');
    }
}
```

## Data Integrity

### Using Transactions

For complex schema changes:

```php
public function up(): void
{
    Db::beginTransaction();
    
    try {
        Schema::table('students', function (Blueprint $table) {
            $table->index('class_id');
        });
        
        Db::commit();
    } catch (\Exception $e) {
        Db::rollBack();
        throw $e;
    }
}
```

### Testing Migrations

Always test migrations in development:

```bash
# Rollback to ensure migration can be reverted
php artisan migrate:rollback

# Run migration
php artisan migrate

# Verify schema
php artisan db:show

# Rollback again to test down() method
php artisan migrate:rollback
```

## Common Issues and Solutions

### Issue: Foreign Key Errors

**Error:** `SQLSTATE[HY000]: General error: 1215 Cannot add foreign key constraint`

**Solutions:**
1. Ensure referenced table and column exist
2. Match data types exactly (both should be uuid or string)
3. Check for existing orphaned records
4. Create index on referenced column first

### Issue: Migration Rollback Failures

**Error:** Migration rollback leaves inconsistent state

**Solutions:**
1. Always implement proper `down()` method
2. Use transactions for complex changes
3. Test rollback in development before deploying

### Issue: Performance Degradation

**Symptom:** Slow queries after schema changes

**Solutions:**
1. Add indexes to UUID foreign keys
2. Use composite indexes for multi-column queries
3. Analyze query performance with `EXPLAIN`

## Migration for Issue #49

The migration `2026_01_09_000001_add_database_indexes_for_uuid_columns.php` adds indexes to:

- `students.class_id`, `students.parent_id`
- `teachers.status`
- `staff.status`
- `marketplace_products.created_by`, `marketplace_products.is_active`
- `transactions.transaction_type`, `transactions.status`
- `staff_attendances.staff_id`, `staff_attendances.attendance_date`
- `leave_requests.staff_id`, `leave_requests.status`, `leave_requests.start_date`
- `learning_materials.virtual_class_id`, `learning_materials.material_type`
- `assignments.virtual_class_id`, `assignments.due_date`
- `quizzes.virtual_class_id`
- `exam_results.exam_id`, `exam_results.student_id`
- `virtual_classes.class_id`
- `calendars.owner_id`
- `calendar_events.calendar_id`

These indexes improve query performance for:
- Student filtering by class and parent
- Teacher and staff status queries
- Transaction filtering and reporting
- Attendance tracking
- Leave request management
- E-learning materials and assignments
- Exam results queries
- Calendar operations

## References

- [Hyperf Database Migrations](https://hyperf.wiki/3.0/#/en/db/migration)
- [Laravel Eloquent: Getting Started](https://laravel.com/docs/eloquent)
- [MySQL UUID Functions](https://dev.mysql.com/doc/refman/8.0/en/miscellaneous-functions.html#function_uuid)

## Contact

For questions about database schema standardization, please refer to:
- Issue #49: https://github.com/sulhicmz/malnu-backend/issues/49
- Database Schema documentation
